---
title: "Mapping"
author: "Ahlam Abuawad, Lizzy Gibson & Yanelli Nunez"
date: "November 14, 2017"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(rvest)
library(httr)
library(stringr)
library(forcats)
library(leaflet)
library(ggthemes)
library(ggplot2)
library(ggmap)
```

## Read Data

**Data from Health Data NY Open Access [Website](https://health.data.ny.gov/Health/Lead-Testing-in-School-Drinking-Water-Sampling-and/rkyy-fsv9).**

* Lead Testing in School Drinking Water Sampling and Results: Most Recently Reported Beginning 2016

```{r read_lead, message = FALSE, warning = FALSE}
#read in lead data, restrict to NYC counties
lead_data <- GET("https://health.data.ny.gov/resource/ja9d-vnbi.csv", query = list(`$limit` = 5000)) %>% 
  content("parsed") %>% 
  clean_names() %>% 
  filter(county %in% c("Queens", "Kings", "New York", "Bronx", "Richmond")) %>% 
  select(school_number = school, location, any_lead_free_buildings, number_of_outlets_result_less, 
         number_of_outlets_result_greater, number_of_outlets, county, school_district)
```

**Data from Health Data NY Open Access [Website](https://health.data.ny.gov/Health/Lead-Testing-in-School-Drinking-Water-Buildings-wi/5hbp-c6bb).**

* Lead Testing in School Drinking Water: Buildings with Lead-Free Plumbing Beginning 2016

```{r read_lead_free, message = FALSE, warning = FALSE}
#read in lead data, restrict to NYC counties
lead_free_data <- GET("https://health.data.ny.gov/resource/mn8r-98tx.csv", query = list(`$limit` = 5000)) %>% 
  content("parsed") %>% 
  clean_names() %>% 
  filter(county %in% c("Queens", "Kings", "New York", "Bronx", "Richmond")) %>% 
  select(school_number = school, county, school_district)
```

***THERE ARE NO SCHOOLS IN NEW YORK CITY WITH LEAD FREE PIPES***

**Data from NYC Open Data [Website](https://data.cityofnewyork.us/Education/2015-16-Guidance-Counselor-Reporting-Demographic-D/iuvu-z276).**

* 2015-16 Guidance Counselor Reporting - Demographic Data

```{r read_demo, message = FALSE, warning = FALSE}
#read in demographic characteristics, create "school_number" to merge with lead data
demo_data <- GET("https://data.cityofnewyork.us/resource/vjn2-hei2.csv", query = list(`$limit` = 2000)) %>% 
  content("parsed") %>% 
  clean_names() %>% 
  select(dbn, school_name, asian, black, english_language_learners, 
         hispanic, other_race = other, poverty, students_with_disabilities,
         white) %>% 
  mutate(asian = as.numeric(asian), asian = round(asian, 4),
         black = as.numeric(black), black = round(black, 4),
         english_language_learners = as.numeric(english_language_learners), 
         english_language_learners = round(english_language_learners, 4),
         hispanic = as.numeric(hispanic), hispanic = round(hispanic, 4),
         other_race = as.numeric(other_race), other_race = round(other_race, 4),
         poverty = as.numeric(poverty), poverty = round(poverty, 4),
         white = as.numeric(white), white = round(white, 4),
         students_with_disabilities = as.numeric(students_with_disabilities), 
         students_with_disabilities = round(students_with_disabilities, 4)) %>% 
  mutate(school_number = str_replace(dbn, "^..", ""))
```

**Data from NYC Open Data [Website](https://data.cityofnewyork.us/Education/2013-2017-School-Math-Results-All/kha6-7i9i).**

* 2013-2017 School Math Results - All

```{r read_scores, message = FALSE, warning = FALSE}
#read in school math scores, restrict to 2017
score_data <- GET("https://data.cityofnewyork.us/resource/stka-4ti9.csv", query = list(`$limit` = 25000)) %>% 
  content("parsed") %>% 
  clean_names() %>% 
  filter(year == 2017) %>% 
  select(dbn, school_name, grade, mean_scale_score)
```

**Merge data**

```{r merge, message = FALSE, warning = FALSE}
#merge demographic characteristics with math scores
school_data <- left_join(demo_data, score_data, by = c("dbn"))

#merge demographic characteristics and math scores with lead data
all_data <- left_join(school_data, lead_data, by = "school_number") %>% 
  filter(mean_scale_score != "s") %>% 
  mutate(mean_scale_score = as.numeric(mean_scale_score),
         lead_percent = number_of_outlets_result_greater / number_of_outlets,
         minority = ifelse(white > 0.5, "White", "Minority")) %>% 
  select(-school_name.y)
```

**Map data**

```{r map, message = FALSE, warning = FALSE}
map_data = lead_data %>% 
  filter(!is.na(location)) %>% 
  mutate(location = str_replace(location, "POINT", ""),
         location = str_replace(location, "\\(", ""),
         location = str_replace(location, "\\)", "")) %>% 
  separate(location, into = c("remove", "latitude"), sep = ".+\\s+", remove = FALSE) %>% 
  separate(location, into = c("extra", "longitude"), sep = "\\s+") %>% 
  select(-extra, -remove)
```
  
**Leaflet**  
  
```{r}
map_data %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(lng = -73.913363354, lat = 40.813679046, popup = "X027")
```

```{r}
library(rworldmap)
new_map = get_map()
  plot(new_map, xlim = c(-73, -74.5), ylim = c(40.25, 41), asp = 1)
  points(map_data$longitude, map_data$latitude, col = "red", cex = .6)
```








